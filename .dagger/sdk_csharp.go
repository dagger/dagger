package main

import (
	"context"
	"fmt"
	"strings"

	"github.com/dagger/dagger/.dagger/internal/dagger"
)

type CsharpSDK struct {
	// +private
	Dagger *DaggerDev
}

func (t CsharpSDK) Name() string {
	return "csharp"
}

// +check
func (t CsharpSDK) Lint(ctx context.Context) error {
	src := t.Dagger.Source.Directory("sdk/csharp")
	return dag.
		CsharpSDKDev(dagger.CsharpSDKDevOpts{Source: src}).
		Lint(ctx)
}

// +check
func (t CsharpSDK) Test(ctx context.Context) error {
	src := t.Dagger.Source.Directory("sdk/csharp")
	return dag.
		CsharpSDKDev(dagger.CsharpSDKDevOpts{Source: src}).
		Test(ctx, t.Dagger.introspectionJSON())
}

// Generate the C# SDK
func (t CsharpSDK) Generate(ctx context.Context) (*dagger.Changeset, error) {
	src := t.Dagger.Source.Directory("sdk/csharp")

	relLayer := dag.
		CsharpSDKDev(dagger.CsharpSDKDevOpts{Source: src}).
		Generate(t.Dagger.introspectionJSON())
	absLayer := dag.Directory().WithDirectory("sdk/csharp", relLayer)
	return absLayer.Changes(dag.Directory()).Sync(ctx)
}

// Test the publishing process
// +check
func (t CsharpSDK) ReleaseDryRun(ctx context.Context) error {
	return t.Publish(ctx, "sdk/csharp/v0.1.0-preview", true, nil)
}

// Publish the C# SDK to NuGet
func (t CsharpSDK) Publish(
	ctx context.Context,
	tag string,

	// +optional
	dryRun bool,

	// +optional
	nugetToken *dagger.Secret,
) error {
	version := strings.TrimPrefix(tag, "sdk/csharp/v")
	src := t.Dagger.Source.Directory("sdk/csharp")
	return dag.
		CsharpSDKDev(dagger.CsharpSDKDevOpts{Source: src}).
		Publish(ctx, t.Dagger.introspectionJSON(), dagger.CsharpSDKDevPublishOpts{
			Version:    version,
			NugetToken: nugetToken,
			DryRun:     dryRun,
		})
}

func (t CsharpSDK) Bump(ctx context.Context, version string) (*dagger.Changeset, error) {
	// trim leading v from version
	version = strings.TrimPrefix(version, "v")

	engineReference := fmt.Sprintf("// Code generated by dagger. DO NOT EDIT.\n\n"+
		"namespace Dagger.SDK;\n\n"+
		"public static class EngineVersion\n"+
		"{\n"+
		"    public const string CLI_VERSION = %q;\n"+
		"}\n", version)

	// NOTE: if you change this path, be sure to update .github/workflows/publish.yml so that
	// provision tests run whenever this file changes.
	layer := t.Dagger.Source.WithNewFile("sdk/csharp/src/Dagger.SDK/EngineVersion.cs", engineReference)
	return layer.Changes(t.Dagger.Source).Sync(ctx)
}
