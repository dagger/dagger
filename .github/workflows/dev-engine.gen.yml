# This file was generated. See https://daggerverse.dev/mod/github.com/dagger/dagger/modules/gha
name: Dev Engine
"on":
    push:
        branches:
            - main
    pull_request:
        types:
            - opened
            - reopened
            - synchronize
            - ready_for_review
    workflow_dispatch: {}
permissions:
    contents: read
concurrency:
    group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
    cancel-in-progress: true
jobs:
    dev-engine:
        runs-on:
            - ${{ github.repository == 'dagger/dagger' && 'nscloud-ubuntu-24.04-amd64-16x32' || 'ubuntu-24.04' }}
        name: Dev Engine
        steps:
            - name: Install Dagger
              uses: dagger/dagger-for-github@v8.2.0
              with:
                version: v0.18.19
            - name: scripts/start-dev-dagger.sh
              id: start-dev-dagger
              run: |
                #!/bin/bash --noprofile --norc -e -o pipefail

                cd $(mktemp -d)
                dagger shell -M -c "git https://github.com/dagger/dagger.git | ref $DAGGER_REF | tree | export ."

                ./hack/build

                export _EXPERIMENTAL_DAGGER_CLI_BIN=$(realpath ./bin/dagger)
                echo "_EXPERIMENTAL_DAGGER_CLI_BIN=$_EXPERIMENTAL_DAGGER_CLI_BIN" >>"${GITHUB_ENV}"
              env:
                _EXPERIMENTAL_DAGGER_DEV_CONTAINER: dagger-engine.dev-${{ github.run_id }}-${{ github.job }}
                _EXPERIMENTAL_DAGGER_DEV_IMAGE: localhost/dagger-engine.dev:${{ github.run_id }}-${{ github.job }}
                DAGGER_REF: ${{ github.sha }}
              shell: bash
            - name: scripts/warm-engine.sh
              id: warm-engine
              run: |
                #!/bin/bash

                # Detect if a dev engine is available, if so: use that
                # We don't rely on PATH because the GHA runner messes with that
                if [[ -n "$_EXPERIMENTAL_DAGGER_CLI_BIN" ]]; then
                  export PATH="$(dirname $_EXPERIMENTAL_DAGGER_CLI_BIN):$PATH"
                  unset _EXPERIMENTAL_DAGGER_RUNNER_HOST
                fi

                which dagger
                dagger version
                dagger core version
              shell: bash
            - name: Checkout
              uses: actions/checkout@v4
            - name: exec
              id: exec
              uses: dagger/dagger-for-github@v8.2.0
              with:
                call: --docker-cfg=file:$HOME/.docker/config.json check --targets=sdk
                cloud-token: oidc
                module: github.com/${{ github.repository }}@${{ github.sha }}
                version: v0.18.19
        timeout-minutes: 20
