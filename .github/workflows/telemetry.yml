name: telemetry

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  collect:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/setup-go@v3
        with:
          go-version: 1.19
      - uses: actions/checkout@v3
      - run: go build ./cmd/otel-collector
      - run: ./otel-collector ./telemetry/groups.log > ./comment.md
        if: always()
        env:
          OTEL_SERVICE_NAME: "dagger"
          OTEL_EXPORTER_OTLP_ENDPOINT: "https://tempo-us-central1.grafana.net:443"
          OTEL_EXPORTER_OTLP_HEADERS: ${{ secrets.OTEL_EXPORTER_OTLP_HEADERS }}
          GRAFANA_CLOUD_USER_ID: "356840"
          GRAFANA_CLOUD_URL: "https://logs-prod-017.grafana.net"
          GRAFANA_CLOUD_API_KEY: ${{ secrets.GRAFANA_CLOUD_API_KEY }}
      - name: Upload Graph
        uses: actions/upload-artifact@v3
        with:
          name: graph.txt
          path: ./telemetry/groups.log
      - name: PR comment
        # Only comment on PRs
        if: github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v2
        with:
          filePath: ./comment.md
          comment_tag: telemetry
