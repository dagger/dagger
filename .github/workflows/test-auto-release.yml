# ⚠️ This is meant to serve as an integration test
# To be deleted after it serves its purpose
name: "Test Auto Release"

on:
  workflow_dispatch:

jobs:
  test-auto-release:
    runs-on: ubuntu-latest
    steps:
      - name: "Check out"
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: "Fixed release version"
        id: next_release_version
        run: |
          echo 'We are setting this explicitly to check that "Update homebrew-core formula" works as expected.'
          echo 'We only want to run this once, and then delete the workflow.'
          echo 'Subsequent runs should be done via the auto-release.yml workflow.'
          next_release_version="v0.2.28"
          echo "NEXT RELEASE VERSION: $next_release_version"
          printf "::set-output name=%s::%s\n" value "$next_release_version"

      # Open a https://github.com/Homebrew/homebrew-core PR to update the bottled formula after we release.
      # This explains why we need to do it separately, on top of GoReleaser updating our Homebrew tap:
      # - https://github.com/Homebrew/homebrew-core/pull/105746#issuecomment-1190522063
      # - https://github.com/dagger/dagger/issues/2823#issuecomment-1190792261
      - name: "Update homebrew-core formula"
        # https://github.com/mislav/bump-homebrew-formula-action
        uses: mislav/bump-homebrew-formula-action@v2
        with:
          download-url: https://github.com/dagger/dagger.git
          formula-name: dagger
          tag-name: ${{ steps.next_release_version.outputs.value }}
          commit-message: |
            {{formulaName}} {{version}}

            Created by ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          COMMITTER_TOKEN: ${{ secrets.RELEASE_DAGGER_CI_TOKEN }}
