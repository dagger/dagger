# syntax = docker/dockerfile:1

FROM node:12-alpine AS build
WORKDIR /app/src
RUN apk add --no-cache file git
COPY --link examples/todoapp/package.json examples/todoapp/yarn.lock ./
COPY --link sdk/nodejs /sdk/nodejs
RUN yarn --cwd /sdk/nodejs/dagger build
RUN yarn
COPY --link examples/todoapp/ .
RUN yarn upgrade dagger
RUN yarn build

FROM node:12-alpine
WORKDIR /app/src
COPY --link --from=build /app/src/package.json /app/src/yarn.lock ./
COPY --link --from=build /sdk/nodejs /sdk/nodejs
RUN yarn --production
COPY --link --from=build /app/src/dist ./dist
COPY --link examples/todoapp/entrypoint.sh /entrypoint
COPY --link examples/todoapp/dagger.graphql /dagger.graphql
ENTRYPOINT ["/entrypoint"]
LABEL moby.buildkit.frontend.caps=moby.buildkit.frontend.inputs
