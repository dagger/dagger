
	extend type Query {
		"Core API"
		core: Core!

		"TODO doc"
		host: Host!
	}

	"Core API"
	type Core {
		"Fetch an OCI image"
		image(ref: String!): Filesystem!

		"Fetch a git repository"
		git(remote: String!, ref: String): Filesystem!

		"Fetch a client directory"
		clientdir(id: String!): Filesystem!
	}

	"TODO move these to their own file"
	type Host {
		workdir: LocalDir!
	}

	"TODO move these to their own file"
	type LocalDir {
		read: Filesystem!
		write(contents: FSID!): Boolean!
	}
	

	scalar FSID

	"""
	A reference to a filesystem tree.

	For example:
	 - The root filesystem of a container
	 - A source code repository
	 - A directory containing binary artifacts

	Rule of thumb: if it fits in a tar archive, it fits in a Filesystem.
	"""
	type Filesystem {
		id: FSID!

		"read a file at path"
		file(path: String!, lines: Int): String

		# FIXME: this should be in execSchema. However, removing this results in an error:
		# failed to resolve all type definitions: [Core Query Filesystem Exec]
		"execute a command inside this filesystem"
		exec(input: ExecInput!): Exec!
	}

	extend type Core {
		"Look up a filesystem by its ID"
		filesystem(id: FSID!): Filesystem!
	}
	

	"Project representation"
	type Project {
		"name of the project"
		name: String!

		"merged schema of the project's sources (if any)"
		schema: String

		"merged operations of the project's sources (if any)"
		operations: String

		"extensions for this project"
		extensions: [Extension!]

		"workflows for this project"
		workflows: [Workflow!]

		"dependencies for this project"
		dependencies: [Project!]

		"install the project, stitching its schema into the API"
		install: Boolean!
	}

	"Extension representation"
	type Extension {
		"path to the extension source in the project filesystem"
		path: String!

		"schema associated with the extension"
		schema: String

		"operations associated with the extension"
		operations: String

		"sdk of the source"
		sdk: String!
	}

	"Workflow representation"
	type Workflow {
		"path to the workflow source in the project filesystem"
		path: String!

		"schema associated with the workflow"
		schema: String

		"operations associated with the workflow"
		operations: String

		"sdk of the source"
		sdk: String!
	}

	extend type Filesystem {
		"load a project's metadata"
		loadProject(configPath: String!): Project!
	}

	extend type Core {
		"Look up a project by name"
		project(name: String!): Project!
	}
	

	"Command execution"
	type Exec {
		"Modified filesystem"
		fs: Filesystem!

		"stdout of the command"
		stdout(lines: Int): String

		"stderr of the command"
		stderr(lines: Int): String

		"Exit code of the command"
		exitCode: Int

		"Modified mounted filesystem"
		mount(path: String!): Filesystem!
	}

	input MountInput {
		"filesystem to mount"
		fs: FSID!

		"path at which the filesystem will be mounted"
		path: String!
	}

	input CacheMountInput {
		"Cache mount name"
		name: String!

		"Cache mount sharing mode (TODO: switch to enum)"
		sharingMode: String!

		"path at which the cache will be mounted"
		path: String!
	}

	input ExecInput {
		"""
		Command to execute
		Example: ["echo", "hello, world!"]
		"""
		args: [String!]!

		"Filesystem mounts"
		mounts: [MountInput!]

		"Cached mounts"
		cacheMounts: [CacheMountInput!]

		"Working directory"
		workdir: String

		"Env vars"
		env: [ExecEnvInput!]

		"Secret env vars"
		secretEnv: [ExecSecretEnvInput!]
	}

	input ExecEnvInput {
		"Env var name"
		name: String!
		"Env var value"
		value: String!
	}

	input ExecSecretEnvInput {
		"Env var name"
		name: String!
		"Secret env var value"
		id: SecretID!
	}

	# FIXME: broken
	# extend type Filesystem {
	#	"execute a command inside this filesystem"
	# 	exec(input: ExecInput!): Exec!
	# }
	

	extend type Filesystem {
		"docker build using this filesystem as context"
		dockerbuild(dockerfile: String): Filesystem!
	}
	

	scalar SecretID

	extend type Core {
		"Look up a secret by ID"
		secret(id: SecretID!): String!

		"Add a secret"
		addSecret(plaintext: String!): SecretID!
	}
	