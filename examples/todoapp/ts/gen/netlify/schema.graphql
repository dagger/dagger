
	extend type Query {
		"Core API"
		core: Core!
	}

	"Core API"
	type Core {
		"Fetch an OCI image"
		image(ref: String!): Filesystem!

		"Fetch a git repository"
		git(remote: String!, ref: String): Filesystem!

		"Fetch a client directory"
		clientdir(id: String!): Filesystem!
	}
	

	scalar FSID

	"""
	A reference to a filesystem tree.

	For example:
	 - The root filesystem of a container
	 - A source code repository
	 - A directory containing binary artifacts

	Rule of thumb: if it fits in a tar archive, it fits in a Filesystem.
	"""
	type Filesystem {
		id: FSID!

		"read a file at path"
		file(path: String!, lines: Int): String

		# FIXME: this should be in execSchema. However, removing this results in an error:
		# failed to resolve all type definitions: [Core Query Filesystem Exec]
		"execute a command inside this filesystem"
		exec(input: ExecInput!): Exec!
	}

	extend type Core {
		"Look up a filesystem by its ID"
		filesystem(id: FSID!): Filesystem!
	}
	

	"Extension representation"
	type Extension {
		"name of the extension"
		name: String!

		"schema of the extension"
		schema: String

		"operations for this extension"
		operations: String

		"dependencies for this extension"
		dependencies: [Extension!]

		"install the extension, stitching its schema into the API"
		install: Boolean!
	}

	extend type Filesystem {
		"load an extension's metadata"
		loadExtension(configPath: String!): Extension!
	}

	extend type Core {
		"Look up an extension by name"
		extension(name: String!): Extension!
	}
	

	"Command execution"
	type Exec {
		"Modified filesystem"
		fs: Filesystem!

		"stdout of the command"
		stdout(lines: Int): String

		"stderr of the command"
		stderr(lines: Int): String

		"Exit code of the command"
		exitCode: Int

		"Modified mounted filesystem"
		mount(path: String!): Filesystem!
	}

	input MountInput {
		"filesystem to mount"
		fs: FSID!

		"path at which the filesystem will be mounted"
		path: String!
	}

	input CacheMountInput {
		"Cache mount name"
		name: String!

		"Cache mount sharing mode (TODO: switch to enum)"
		sharingMode: String!

		"path at which the cache will be mounted"
		path: String!
	}

	input ExecInput {
		"""
		Command to execute
		Example: ["echo", "hello, world!"]
		"""
		args: [String!]!

		"Filesystem mounts"
		mounts: [MountInput!]

		"Cached mounts"
		cacheMounts: [CacheMountInput!]

		"Working directory"
		workdir: String

		"Env vars"
		env: [ExecEnvInput!]

		"Secret env vars"
		secretEnv: [ExecSecretEnvInput!]
	}

	input ExecEnvInput {
		"Env var name"
		name: String!
		"Env var value"
		value: String!
	}

	input ExecSecretEnvInput {
		"Env var name"
		name: String!
		"Secret env var value"
		id: SecretID!
	}

	# FIXME: broken
	# extend type Filesystem {
	#	"execute a command inside this filesystem"
	# 	exec(input: ExecInput!): Exec!
	# }
	

	extend type Filesystem {
		"docker build using this filesystem as context"
		dockerbuild(dockerfile: String): Filesystem!
	}
	

	scalar SecretID

	extend type Core {
		"Look up a secret by ID"
		secret(id: SecretID!): String!

		"Add a secret"
		addSecret(plaintext: String!): SecretID!
	}
	

extend type Query {
  netlify: Netlify!
}

type Netlify {
  deploy(
    contents: FSID!
    subdir: String
    siteName: String
    token: SecretID!
  ): SiteURLs!
}

type SiteURLs {
  url: String!
  deployURL: String!
  logsURL: String
}

extend type Filesystem {
  netlifyDeploy(subdir: String, siteName: String, token: SecretID!): SiteURLs!
}
