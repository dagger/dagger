type Tests {
  let fixtureSitePath: String! = "modules/docusaurus/tests/testdata/runtime/site-basic"
  let fixturePackageJSONPath: String! = fixtureSitePath + "/package.json"
  let fixtureFormatSitePath: String! = "modules/docusaurus/tests/testdata/runtime/site-format"
  let fixtureFormatPackageJSONPath: String! = fixtureFormatSitePath + "/package.json"

  let runtimePaths(ws: Workspace!): [String!]! {
    docusaurus
      .site(ws, fixtureSitePath)
      .runtimeExternalPaths(ws)
  }

  """
  Detects both external file and directory dependencies accessed at runtime.
  """
  pub detectsExternalDependencies(ws: Workspace!): Void @check {
    let paths = runtimePaths(ws)

    let hasExternalPlugin = paths
      .filter { dep => dep == "../shared/local-plugin.js" }
      .length > 0
    if (hasExternalPlugin == false) {
      raise "missing external plugin dependency"
    }

    let hasExternalAssetsDir = paths
      .filter { dep => dep == "../shared-assets" }
      .length > 0
    let hasExternalAssetsFile = paths
      .filter { dep => dep == "../shared-assets/a.txt" }
      .length > 0
    if (hasExternalAssetsDir == false and hasExternalAssetsFile == false) {
      raise "missing external directory dependency"
    }

    null
  }

  """
  Ensures all returned paths are outside the site directory.
  """
  pub excludesSiteLocalPaths(ws: Workspace!): Void @check {
    let nonExternal = runtimePaths(ws)
      .filter { dep => dep.trimPrefix("../") == dep }

    if (nonExternal.length > 0) {
      raise "runtimeExternalPaths returned an in-site path"
    }

    null
  }

  """
  Ensures optimizeConfig writes deterministic runtimeExternalPaths into package.json docusaurus.include.
  """
  pub optimizeConfigUsesRuntimePaths(ws: Workspace!): Void @check {
    let site = docusaurus.site(ws, fixtureSitePath)
    let expected = runtimePaths(ws)
    let updatedPackageJSON = site
      .optimizeConfig(ws)
      .layer
      .file(fixturePackageJSONPath)
      .asJSON

    let actual = updatedPackageJSON
      .field(["docusaurus", "include"])
      .asArray
      .{asString}
      .map { item => item.asString }

    if (actual.length != expected.length) {
      raise "optimizeConfig wrote an unexpected include list length"
    }

    for (dep in expected) {
      let present = actual.filter { path => path == dep }.length > 0
      if (present == false) {
        raise "optimizeConfig missed runtime dependency: " + dep
      }
    }

    null
  }

  """
  Ensures optimizeConfig preserves unrelated package.json formatting.
  """
  pub optimizeConfigPreservesFormatting(ws: Workspace!): Void @check {
    let site = docusaurus.site(ws, fixtureFormatSitePath)
    let optimizedPackageJSON = site
      .optimizeConfig(ws)
      .layer
      .file(fixtureFormatPackageJSONPath)
    let optimizedPackageJSONContents = optimizedPackageJSON.contents

    let hasOneLineScriptsField = optimizedPackageJSONContents
      .split("\"scripts\": { \"build\": \"docusaurus build\" }")
      .length > 1
    if (hasOneLineScriptsField == false) {
      raise "optimizeConfig rewrote unrelated package.json formatting"
    }

    let include = optimizedPackageJSON
      .asJSON
      .field(["docusaurus", "include"])
      .asArray
      .{asString}
      .map { item => item.asString }

    let hasExternalPlugin = include
      .filter { dep => dep == "../shared/local-plugin.js" }
      .length > 0
    if (hasExternalPlugin == false) {
      raise "optimizeConfig did not write expected include entries"
    }

    null
  }

  """
  Runs all checks.
  """
  pub all(ws: Workspace!): Void @check {
    detectsExternalDependencies(ws)
    excludesSiteLocalPaths(ws)
    optimizeConfigUsesRuntimePaths(ws)
    optimizeConfigPreservesFormatting(ws)
    null
  }
}
