import {
  dag,
  Container,
  object,
  func,
  Directory,
  field,
} from "@dagger.io/dagger"

@object()
class TypescriptSdkDev {
  /**
   * Project dev environment container.
   *
   * Open a shell in with: `dagger call --source=. project terminal`
   */
  @field()
  project: Container

  constructor(source: Directory) {
    // Extract package.json and yarn.lock to a temporary directory
    const dependencyFiles = dag
      .directory()
      .withFile("package.json", source.file("package.json"))
      .withFile("yarn.lock", source.file("yarn.lock"))

    // Get source without generated files nor useless files.
    const sourceCode = dag.directory().withDirectory("/", source, {
      include: [
        "**/*.ts",
        "tsconfig.json",
        "package.json",
        "yarn.lock",
        ".mocharc.json",
        ".eslintrc.cjs",
        ".prettierrc.cjs",
      ],
      exclude: ["node_modules", "dist", "dev"],
    })

    // Install dependencies and add source code.
    this.project = dag
      .node()
      .withYarn()
      .withSource(dependencyFiles)
      .install() // Install dependencies prior to adding source to improve caching
      .withSource(sourceCode)
      .container()
      .withDefaultTerminalCmd(["/bin/sh"])
  }

  /**
   * Execute the TypeScript SDK unit tests.
   *
   * Example usage: `dagger call --source=. test stdout`
   * Trigger a specific test: `dagger call --source=. test --args="-f","<test>" stdout`
   *
   * @param args Arguments to pass to the test command.
   */
  @func()
  test(...args: string[]): Container {
    // We cannot use node module here because the tests
    // need access to experimental dagger.
    // TODO: fix provisioning tests (that will be outdated with 0.10??)
    return this.project.withExec(["test", ...args], {
      experimentalPrivilegedNesting: true,
    })
  }

  /**
   * Lint the TypeScript SDK.
   *
   * Example usage: `dagger call --source=. lint stdout`
   */
  @func()
  lint(): Container {
    return dag.node({ ctr: this.project }).commands().lint()
  }

  /**
   * Build the TypeScript SDK.
   *
   * Example usage `dagger call --source=. build directory --path dist -o ./dist `
   */
  @func()
  build(): Container {
    return dag.node({ ctr: this.project }).commands().build()
  }

  /**
   * Bump the TypeScript SDK's Engine dependency.
   *
   * Example usage: `dagger -m dev call --source=. bump --version v0.10.2 -o .`
   *
   * @param version The version to use
   */
  @func()
  bump(version: string): Directory {
    // Trim leading v from version
    if (version.startsWith("v")) {
      version = version.substring(1)
    }

    // NOTE: if you change this path, be sure to update .github/workflows/publish.yml so that
    // provision tests run whenever this file changes.
    const engineVersionPath = "provisioning/default.ts"
    const engineReference = `// Code generated by dagger. DO NOT EDIT.
export const CLI_VERSION = "${version}"\n`

    return this.project
      .directory("/src")
      .diff(
        this.project
          .directory("/src")
          .withNewFile(engineVersionPath, engineReference),
      )
  }
}
